name: mongodb

on:
  # Runs every sunday
  schedule:
      - cron: '0 0 * * SUN'

  # Runs for pull requests
  pull_request:
    branches:
      - master

  # Runs on publish
  release:
    types:
      [published]

  # Allow manual triggers
  workflow_dispatch:

jobs:
  # Label of the container job
  container-job:
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_USER: username
          POSTGRES_DB: milabench


    steps:
      # Downloads a copy of the code in your repository before running CI tests
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: dependencies
        run: |
          if [[ ! -d "~/.cargo/bin" ]]; then
            wget --no-check-certificate --secure-protocol=TLSv1_2 -qO- https://sh.rustup.rs | sh -s -- -y 
          fi
          export PATH="~/.cargo/bin:${PATH}"
          python -m pip install -U pip
          python -m pip install -U poetry
          poetry lock --no-update
          poetry install

      - name: Connect to PostgreSQL
        env:
          POSTGRES_USER: username
          POSTGRES_PSWD: password
          POSTGRES_DB: milabench
          POSTGRES_HOST: postgres
          POSTGRES_PORT: 5432
        run: pytest tests/integration
