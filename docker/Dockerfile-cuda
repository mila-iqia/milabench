# FROM ubuntu:22.04

FROM nvidia/cuda:12.9.1-runtime-ubuntu24.04


# Arguments
# ---------

# Use ofed_info -s to get your local version
ARG MOFED_VERSION=5.4-3.4.0.0
ARG CONFIG=stacc.yaml
ARG ARCH=cuda

ENV MILABENCH_GPU_ARCH=$ARCH
ENV MILABENCH_CONFIG_NAME=$CONFIG
ENV MILABENCH_DOCKER=1

# Paths
# -----

ENV MILABENCH_CONFIG=/milabench/milabench/config/$MILABENCH_CONFIG_NAME
ENV MILABENCH_BASE=/milabench/envs
ENV MILABENCH_OUTPUT=/milabench/results/
ENV MILABENCH_ARGS=""

# Copy milabench
# --------------

WORKDIR /milabench
COPY . /milabench/milabench/

# Install Dependencies
# --------------------

#            curl: used to download anaconda and rust
#             git: used by milabench
#      libibverbs: used for infiniband
#           rustc: used by BERT models inside https://pypi.org/project/tokenizers/
# build-essential: for rust


ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update -y &&\
    apt-get install -y --no-install-recommends zip ssh rsync git build-essential curl python3 python3-virtualenv python-is-python3 python3-pip libgl1 libglib2.0-0 gcc g++ python3-dev &&\
    curl -o /etc/apt/trusted.gpg.d/mellanox.asc https://content.mellanox.com/ofed/RPM-GPG-KEY-Mellanox &&\
    curl -o /etc/apt/sources.list.d/mellanox.list https://linux.mellanox.com/public/repo/mlnx_ofed/${MOFED_VERSION}/ubuntu22.04/mellanox_mlnx_ofed.list &&\
    apt-get update -y &&\
    apt-get install -y --no-install-recommends libibverbs1 &&\
    apt-get clean &&\
    rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
ENV CUDA_HOME=/usr/local/cuda-12/
ENV XDG_CACHE_HOME=/milabench/envs/cache

# Install Milabench
# -----------------

ENV MILAENCH_ENV=/milabench/.env

RUN RUN curl -LsSf https://astral.sh/uv/install.sh | sh                 &&\
    virtualenv $MILAENCH_ENV                                            &&\
    $MILAENCH_ENV/bin/python -m pip install -U pip                      &&\
    $MILAENCH_ENV/bin/python -m pip install -U setuptools               &&\
    $MILAENCH_ENV/bin/python -m pip install -U poetry                   &&\
    $MILAENCH_ENV/bin/python -m pip install -e /milabench/milabench[cuda]    &&\
    $MILAENCH_ENV/bin/python -m pip cache purge

# Prepare bench
# -------------

# pip times out often when downloading pytorch
ENV PIP_DEFAULT_TIMEOUT=800

# https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/index.html#gpu-feature-list
ENV TORCH_CUDA_ARCH_LIST="7.5;8.0;8.6;8.9"

RUN ln -s /milabench/.env/bin/milabench /usr/local/bin/milabench                                          &&\
    $MILAENCH_ENV/bin/milabench install --config $MILABENCH_CONFIG --base $MILABENCH_BASE $MILABENCH_ARGS &&\
    python -m pip cache purge

# CMD milabench run
